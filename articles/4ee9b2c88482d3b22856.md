---
title: 'Cloudflare Workersã§GCSã®ç½²åä»˜ãURLã‚’ä½œæˆã™ã‚‹'
emoji: 'ğŸš–'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  ['cloudflare', 'cloudflareworkers', 'cloudflarepages', 'hono', 'typescript']
published: true
---

GCS ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆã‚µãƒ¼ãƒãƒ¼å´ã§ Google Cloud SDK ã‚’ä½¿ã£ã¦ç½²åä»˜ã URL ã‚’ä½œæˆã™ã‚Œã°ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

```ts
import {Storage} from '@google-cloud/storage';

const options = {
  version: 'v4',
  action: 'write',
  expires: Date.now() + 15 * 60 * 1000, // 15 minutes
  contentType: 'image/png',
};

const [url] = await storage
  .bucket('my-bucket-name')
  .file('example.png')
  .getSignedUrl(options);
```

ãŸã ã€`@google-cloud/storage`ã¯ Node.js ç’°å¢ƒå‘ã‘ãªã®ã§`fs`ãªã©ã® Node.js çµ„ã¿è¾¼ã¿é–¢æ•°ãŒä½¿ã‚ã‚Œã¦ãŠã‚Šã€Cloudflare Workers/Cloudflare Pages Functions ã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

# Hono ã®ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹

ä»Šå›ã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ [ç‹¬è‡ªã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½¿ç”¨ã—ãŸ V4 ç½²åãƒ—ãƒ­ã‚»ã‚¹](https://cloud.google.com/storage/docs/access-control/signing-urls-manually?hl=ja) ã‚’å‚è€ƒã«è‡ªå‰ã§ç½²åä»˜ã URL ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

/src/routes/api.ts

```ts
import {zValidator} from '@hono/zod-validator';
import {Hono} from 'hono';
import {env} from 'hono/adapter';
import {z} from 'zod';
import {generateSignedUrl} from '../services/cloudStorage';

type Bindings = {
  SERVICE_ACCOUNT_KEY_JSON: string;
};

export const apiRoutes = new Hono<{Bindings: Bindings}>().get(
  '/signed-url',
  zValidator(
    'query',
    z.object({'object-name': z.string(), 'file-type': z.string()})
  ),
  async c => {
    const {SERVICE_ACCOUNT_KEY_JSON} = env(c);
    const serviceAccountKey = JSON.parse(SERVICE_ACCOUNT_KEY_JSON);

    const signedUrl = await generateSignedUrl({
      bucketName: 'my-bucket-name', // ä¿å­˜ã—ãŸã„ãƒã‚±ãƒƒãƒˆã®åå‰
      objectName: c.req.valid('query')['object-name'], // queryã§å—ã‘å–ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«å (ä¾‹: example.png)
      fileType: c.req.valid('query')['file-type'], // queryã§å—ã‘å–ã£ãŸContent-Type (ä¾‹: 'image/png)
      serviceAccountKey,
    });

    return c.json({signedUrl});
  }
);
```

Hono ã‚’ä½¿ã£ã¦ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ä¾‹ã§ã™ã€‚`hono/adapter`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ç•°ãªã‚‹ç’°å¢ƒã§ã®ç’°å¢ƒå¤‰æ•°ã®å‘¼ã³å‡ºã—æ–¹ãŒçµ±ä¸€ã•ã‚Œã¾ã™ã€‚
Google Cloud SDK ã‚’ä½¿ç”¨ã›ãšã«ç½²åä»˜ã URL ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã€`GOOGLE_APPLICATION_CREDENTIALS=./service-account-key.json` ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒãªã„ç‚¹ãŒä¾¿åˆ©ã§ã™ã€‚

.dev.vars

```
SERVICE_ACCOUNT_KEY_JSON = {"type":"service_account","project_id": // ä»¥ä¸‹ç•¥
```

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯`.dev.vars`ã«ä¸Šè¨˜ã®ã‚ˆã†ã«æ›¸ãè¾¼ã¿ã€Cloudflare ä¸Šã§ã¯è¨­å®šã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰`SERVICE_ACCOUNT_KEY_JSON`ã‚’è¨­å®šã—ã¾ã™ã€‚
æ”¹è¡Œãªã—ã§ 1 è¡Œã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

# ç½²åä»˜ã URL ã‚’ç™ºè¡Œã™ã‚‹

services/cloudStorage.ts

```ts
interface ServiceAccountKey {
  type: string;
  project_id: string;
  private_key_id: string;
  private_key: string;
  client_email: string;
  client_id: string;
  auth_uri: string;
  token_uri: string;
  auth_provider_x509_cert_url: string;
  client_x509_cert_url: string;
  universe_domain: string;
}

export const generateSignedUrl = async ({
  bucketName,
  objectName,
  fileType,
  expiration = 15 * 60, // 15 minutes
  httpMethod = 'PUT',
  serviceAccountKey,
}: GenerateSignedUrlOptions): Promise<string> => {
  if (expiration > 15 * 60) {
    throw new Error(
      "Expiration Time can't be longer than 900 seconds (15 minutes)."
    );
  }

  const datetimeNow = new Date();
  const requestTimestamp = datetimeNow
    .toISOString()
    .replace(/[:-]|\.\d{3}/g, '');
  const datestamp = requestTimestamp.slice(0, 8);

  const clientEmail = serviceAccountKey.client_email;
  const credentialScope = `${datestamp}/auto/storage/goog4_request`;
  const credential = `${clientEmail}/${credentialScope}`;

  const canonicalUri = `/${objectName}`;
  const host = `${bucketName}.storage.googleapis.com`;

  const canonicalHeaders = `content-type:${fileType}\nhost:${host}\n`;
  const signedHeaders = 'content-type;host';

  const queryParameters = {
    'X-Goog-Algorithm': 'GOOG4-RSA-SHA256',
    'X-Goog-Credential': credential,
    'X-Goog-Date': requestTimestamp,
    'X-Goog-Expires': expiration.toString(),
    'X-Goog-SignedHeaders': signedHeaders,
  };

  const canonicalQueryString = new URLSearchParams(queryParameters).toString();

  const canonicalRequest = [
    httpMethod,
    canonicalUri,
    canonicalQueryString,
    canonicalHeaders,
    signedHeaders,
    'UNSIGNED-PAYLOAD',
  ].join('\n');

  const canonicalRequestHash = SHA256(canonicalRequest).toString(enc.Hex);

  const stringToSign = [
    'GOOG4-RSA-SHA256',
    requestTimestamp,
    credentialScope,
    canonicalRequestHash,
  ].join('\n');

  const sign = await signString(serviceAccountKey.private_key, stringToSign); // signString()ã¯å¾Œè¿°

  // å‡ºæ¥ä¸ŠãŒã£ãŸç½²åä»˜ãURL
  const signedUrl = `https://${bucketName}.storage.googleapis.com/${objectName}?${canonicalQueryString}&x-goog-signature=${sign}`;

  return signedUrl;
};
```

å…¬å¼ã® Python ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã« TypeScript ã§å†å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ã“ã®è¾ºã‚Šã¯ä»•æ§˜é€šã‚Šã«è©°ã‚ã¦ã„ãã ã‘ãªã®ã§ `print()` ã‚„ `console.log()` ã—ãªãŒã‚‰é€²ã‚ã‚Œã°ã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…ã§ãã¾ã™ã€‚

`signString()` ã®éƒ¨åˆ†ãŒãŒé›£ã—ãã€Python ã¨åŒã˜ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã®ãŒå›°é›£ã§ã™ã€‚ã¾ãŸã€ Node.js ã¨ V8(Cloudflare Workers) ã§å®Ÿè¡Œç’°å¢ƒã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®é–¢æ•°ã§ã¯ã€SHA256 ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸå€¤ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® private_key ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

services/cloudStorage.ts

```ts
const base64ToArrayBuffer = (base64: string): ArrayBuffer => {
  const binaryString = ((): string => {
    if (typeof Buffer !== 'undefined') {
      // NOTE: Bufferã¯Node.jsã®é–¢æ•°ãªã®ã§Workersã®V8ç’°å¢ƒã«ã¯å­˜åœ¨ã—ãªã„
      return Buffer.from(base64, 'base64').toString('binary');
      // biome-ignore lint/style/noUselessElse: <explanation>
    } else {
      // Cloudflare Workers and browsers (V8)
      return atob(base64);
    }
  })();

  const bytes = new Uint8Array(binaryString.length);

  const uint8Array = binaryString.split('').reduce((acc, char, index) => {
    acc[index] = char.charCodeAt(0);
    return acc;
  }, bytes);

  return uint8Array.buffer;
};

const importPrivateKey = async (pem: string): Promise<CryptoKey> => {
  const pemHeader = '-----BEGIN PRIVATE KEY-----';
  const pemFooter = '-----END PRIVATE KEY-----';

  const pemContents = pem.substring(
    pemHeader.length,
    pem.length - pemFooter.length - 1
  );
  const binaryDer = base64ToArrayBuffer(pemContents.replace(/\s/g, ''));

  return crypto.subtle.importKey(
    'pkcs8',
    binaryDer,
    {name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256'},
    true,
    ['sign']
  );
};

const signString = async (
  privateKeyPem: string,
  stringToSign: string
): Promise<string> => {
  const privateKey = await importPrivateKey(privateKeyPem);

  const encoder = new TextEncoder();
  const data = encoder.encode(stringToSign);
  const signature = await crypto.subtle.sign(
    'RSASSA-PKCS1-v1_5',
    privateKey,
    data
  );

  return Array.from(new Uint8Array(signature))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
};
```

æ¸¡ã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥å€¤ã‚’ PKCS#1 v1.5 ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’é©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã§ãƒãƒƒã‚·ãƒ¥å€¤ã«ç‰¹å®šã®å½¢å¼ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒè¿½åŠ ã•ã‚Œç½²åã«é©ã—ãŸé•·ã•ã«ãªã‚Šã¾ã™ã€‚

`signString()`ã¯ RSA ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã«ç½²åã™ã‚‹é–¢æ•° signString ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ç½²åã¯ RSA-SHA256 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ PKCS1v1.5 ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆã•ã‚Œã€ãã®çµæœã‚’ 16 é€²æ•°ã®æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

`importPrivateKey()`ã¯ privateKeyPem ã‹ã‚‰ prefix,suffix ã‚’å–ã‚Šé™¤ã„ã¦ CryptoKey ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ã¦ã„ã¾ã™ã€‚

`binaryString()`ã¯ Base64 æ–‡å­—åˆ—ã‚’ ArrayBuffer ã«å¤‰æ›ã™ã‚‹é–¢æ•°ã§ã™ã€‚
Vite ã§å®Ÿè¡Œã—ãŸ Node.js ç’°å¢ƒã¨ wrangler/Cloudflare ã§å®Ÿè¡Œã—ã¦ã‚‹ V8 ã§å ´åˆåˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã§ Cloudflare Workers ã§ç½²åä»˜ã URL ãŒä½œæˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

# ç½²åä»˜ã URL ã‚’ä½¿ã£ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ä¸Šè¨˜ã§ä½œæˆã—ãŸ API ã‹ã‚‰ç½²åä»˜ã URL ã‚’å–å¾—ã—ã€`fetch()`ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ PUT ã§é€ã‚Œã° GCS ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒã§ãã¾ã™ã€‚

```ts
const name: string = 'example.png'; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«å
const file: File; // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¥ã‚Œã‚‹

honoClient.api['signed-url']
  .$get({query: {'object-name': name, 'file-type': file.type}})
  .then(async res => {
    const {signedUrl} = await res.json();
    fetch(signedUrl, {
      method: 'PUT',
      headers: {'Content-Type': file.type},
      body: file,
    }).then(() => {
      console.log('success');
    });
  });
```
